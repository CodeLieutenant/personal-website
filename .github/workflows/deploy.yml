name: "Deploy"

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to deploy"
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: executing remote ssh commands using password
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_PRIVATE_KEY }}
          passphrase: ${{ secrets.SERVER_PRIVATE_KEY_PASSPHRASE }}
          port: 22
          script: |
            docker login ${{ secrets.REGISTRY }} \
              --username ${{ secrets.REGISTRY_USERNAME }} \
              --password ${{ secrets.REGISTRY_TOKEN }} || exit 1

            docker pull "${{ env.IMAGE }}:${{ inputs.version }}"

            docker logout ${{ secrets.REGISTRY }}

            docker stop -s SIGINT -t 30 website scheduler pulse_work pulse_check sqs

            docker exec -it horizon php artisan horizon:terminate
            docker exec -it horizon php artisan horizon:purge
            docker exec -it horizon php artisan horizon:clear-metrics
            docker stop -s SIGINT -t 30 horizon

            docker rm -f horizon website pulse_work pulse_check scheduler sqs

            docker run --name extract-static-files --rm -it -v "${{ env.STATIC_FILES }}:/extract" "$IMAGE" cp -a "${{ env.CONTAINER_STATIC_FILES }}/." "/extract"

            docker run \
              --name migrate \
              --rm \
              --network website \
              --add-host=host.docker.internal:host-gateway \
              --env-file "${{ secrets.ENV_FILE }}" \
              -it "${{ env.IMAGE }}:${{ inputs.version }}" \
              php artisan migrate -n --force

              sudo mkdir -p "${{ env.STATIC_FILES }}"
              sudo mkdir -p "${{ env.LOCAL_STORAGE }}"
              sudo mkdir -p "${{ env.LOCAL_STORAGE }}/public"
              sudo mkdir -p "${{ env.LOGS_PATH }}"

              if [[ ! -L "${{ env.STATIC_FILES }}/storage" ]]; then
                  sudo ln -s \
                    ${{ env.LOCAL_STORAGE }}/public \
                    ${{ env.STATIC_FILES }}/storage
              fi

              docker run \
              	-it \
              	--name website \
              	-d \
              	--restart unless-stopped \
              	-p 8000:80 \
              	--network website \
              	-v "${{ env.LOGS_PATH }}:${{ env.LOGS_PATH }}" \
              	-v "${{ env.STATIC_FILES }}:${{ env.CONTAINER_STATIC_FILES }}" \
              	-v "${{ env.LOCAL_STORAGE }}:${{ env.CONTAINER_LOCAL_STORAGE }}" \
              	-v "${{ env.LOCAL_STORAGE }}/public:${{ env.LOCAL_STORAGE }}/public" \
              	--add-host=host.docker.internal:host-gateway \
              	--env-file "${{ secrets.ENV_FILE }}" \
              	-e "SERVER_NAME=dusanmalusev.dev" \
              	"${{ env.IMAGE }}:${{ inputs.version }}" \
              	php \
              	  -d variables_order=EGPCS \
              	  /var/www/html/artisan serve \
              	  --host=0.0.0.0 \
              	  --port=80 \
              	  --tries=3

              docker run \
              	-it \
              	--name scheduler \
              	-d \
              	--restart unless-stopped \
              	--network website \
              	-v "${{ env.LOGS_PATH }}/scheduler:${{ env.LOGS_PATH }}" \
              	-v "${{ env.STATIC_FILES }}:${{ env.CONTAINER_STATIC_FILES }}" \
              	-v "${{ env.LOCAL_STORAGE }}:${{ env.CONTAINER_LOCAL_STORAGE }}" \
              	-v "${{ env.LOCAL_STORAGE }}/public:${{ env.LOCAL_STORAGE }}/public" \
              	--add-host=host.docker.internal:host-gateway \
              	--env-file "${{ secrets.ENV_FILE }}" \
              	-e "SERVER_NAME=dusanmalusev.dev" \
              	"${{ env.IMAGE }}:${{ inputs.version }}" \
              	php artisan schedule:work -n --ansi

              docker run \
              	-it \
              	--name horizon \
              	-d \
              	--restart unless-stopped \
              	--network website \
              	-v "${{ env.LOGS_PATH }}/scheduler:${{ env.LOGS_PATH }}" \
              	-v "${{ env.STATIC_FILES }}:${{ env.CONTAINER_STATIC_FILES }}" \
              	-v "${{ env.LOCAL_STORAGE }}:${{ env.CONTAINER_LOCAL_STORAGE }}" \
              	-v "${{ env.LOCAL_STORAGE }}/public:${{ env.LOCAL_STORAGE }}/public" \
              	--add-host=host.docker.internal:host-gateway \
              	--env-file "${{ secrets.ENV_FILE }}" \
              	-e "SERVER_NAME=dusanmalusev.dev" \
              	"${{ env.IMAGE }}:${{ inputs.version }}" \
              	php artisan horizon -n --ansi

              docker run \
              	-it \
              	--name horizon \
              	-d \
              	--restart unless-stopped \
              	--network website \
              	-v "${{ env.LOGS_PATH }}/scheduler:${{ env.LOGS_PATH }}" \
              	-v "${{ env.STATIC_FILES }}:${{ env.CONTAINER_STATIC_FILES }}" \
              	-v "${{ env.LOCAL_STORAGE }}:${{ env.CONTAINER_LOCAL_STORAGE }}" \
              	-v "${{ env.LOCAL_STORAGE }}/public:${{ env.LOCAL_STORAGE }}/public" \
              	--add-host=host.docker.internal:host-gateway \
              	--env-file "${{ secrets.ENV_FILE }}" \
              	-e "SERVER_NAME=dusanmalusev.dev" \
              	"${{ env.IMAGE }}:${{ inputs.version }}" \
              	php artisan horizon -n --ansi

              docker run \
              	-it \
              	--name pulse_check \
              	-d \
              	--restart unless-stopped \
              	--network website \
              	-v "${{ env.LOGS_PATH }}/scheduler:${{ env.LOGS_PATH }}" \
              	-v "${{ env.STATIC_FILES }}:${{ env.CONTAINER_STATIC_FILES }}" \
              	-v "${{ env.LOCAL_STORAGE }}:${{ env.CONTAINER_LOCAL_STORAGE }}" \
              	-v "${{ env.LOCAL_STORAGE }}/public:${{ env.LOCAL_STORAGE }}/public" \
              	--add-host=host.docker.internal:host-gateway \
              	--env-file "${{ secrets.ENV_FILE }}" \
              	-e "SERVER_NAME=dusanmalusev.dev" \
              	"${{ env.IMAGE }}:${{ inputs.version }}" \
              	php artisan pulse:check -n --ansi

              docker run \
              	-it \
              	--name pulse_work \
              	-d \
              	--restart unless-stopped \
              	--network website \
              	-v "${{ env.LOGS_PATH }}/scheduler:${{ env.LOGS_PATH }}" \
              	-v "${{ env.STATIC_FILES }}:${{ env.CONTAINER_STATIC_FILES }}" \
              	-v "${{ env.LOCAL_STORAGE }}:${{ env.CONTAINER_LOCAL_STORAGE }}" \
              	-v "${{ env.LOCAL_STORAGE }}/public:${{ env.LOCAL_STORAGE }}/public" \
              	--add-host=host.docker.internal:host-gateway \
              	--env-file "${{ secrets.ENV_FILE }}" \
              	-e "SERVER_NAME=dusanmalusev.dev" \
              	"${{ env.IMAGE }}:${{ inputs.version }}" \
              	php artisan pulse:work -n --ansi

              docker run \
              	-it \
              	--name sqs \
              	-d \
              	--restart unless-stopped \
              	--network website \
              	-v "${{ env.LOGS_PATH }}/scheduler:${{ env.LOGS_PATH }}" \
              	-v "${{ env.STATIC_FILES }}:${{ env.CONTAINER_STATIC_FILES }}" \
              	-v "${{ env.LOCAL_STORAGE }}:${{ env.CONTAINER_LOCAL_STORAGE }}" \
              	-v "${{ env.LOCAL_STORAGE }}/public:${{ env.LOCAL_STORAGE }}/public" \
              	--add-host=host.docker.internal:host-gateway \
              	--env-file "${{ secrets.ENV_FILE }}" \
              	-e "SERVER_NAME=dusanmalusev.dev" \
              	"${{ env.IMAGE }}:${{ inputs.version }}" \
              	php artisan queue:work sqs --max-jobs=1000 --sleep=3 --tries=3 --max-time=3600
